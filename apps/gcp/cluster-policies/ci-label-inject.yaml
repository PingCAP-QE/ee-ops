apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: inject-ci-labels
spec:
  failurePolicy: Ignore
  rules:
    - name: inject-labels-from-annotations
      match:
        resources:
          kinds:
            - Pod
          namespaces:
            - jenkins-tiflow
      context:
        - name: whitelist
          configMap:
            name: ci-label-whitelist
            namespace: infra
      preconditions:
        all:
          - key: "{{ request.object.metadata.annotations.\"ci_refs\" || '' }}"
            operator: NotEquals
            value: ""
          - key: "{{ request.object.metadata.annotations.\"ci_job\" || '' }}"
            operator: In
            value: "{{ whitelist.data.jobs | from_json(@) }}"
      mutate:
        patchStrategicMerge:
          metadata:
            labels:
              author: "{{ not_null((request.object.metadata.annotations.\"ci_refs\" | from_json(@)).pulls[0].author, request.object.metadata.annotations.\"ci_trigger_user\", '') | to_lower(@) | regex_replace_all(@, '[^a-z0-9_-]', '_') | regex_replace_all(@, '^[-_]+|[-_]+$', '') | regex_replace_all(@, '^(.{0,63}).*$', '$1') }}"
              org: "{{ not_null((request.object.metadata.annotations.\"ci_refs\" | from_json(@)).org, '') | to_lower(@) | regex_replace_all(@, '[^a-z0-9_-]', '_') | regex_replace_all(@, '^[-_]+|[-_]+$', '') | regex_replace_all(@, '^(.{0,63}).*$', '$1') }}"
              repo: "{{ not_null((request.object.metadata.annotations.\"ci_refs\" | from_json(@)).repo, '') | to_lower(@) | regex_replace_all(@, '[^a-z0-9_-]', '_') | regex_replace_all(@, '^[-_]+|[-_]+$', '') | regex_replace_all(@, '^(.{0,63}).*$', '$1') }}"
              env: cicd
