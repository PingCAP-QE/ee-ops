apiVersion: apps/v1
kind: Deployment
metadata:
  name: sec-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sec-server
  template:
    metadata:
      labels:
        app: sec-server
    spec:
      serviceAccountName: sec-account
      imagePullSecrets:
        - name: ${IMAGE_PULL_SECRET}
      volumes:
        - name: redis-cred
          secret:
            secretName: redis
        - name: db-cred
          secret:
            secretName: db
        - name: bucket-cred
          secret:
            secretName: bucket
      containers:
        - name: sec-server-container
          image: screw111/test-sec-agent:s1.8
          args:
            - --redis-user-file
            - /etc/redis/username
            - --redis-password-file
            - /etc/redis/password
            - --db-dsn-file
            - /etc/db/dsn      
            - --s3-cred-file
            - /etc/bucket/cred.json
          ports:
            - name: http
              containerPort: 8888
          env:
            - name: APP_ENV
              value: "prod"
          resources:
            limits:
              cpu: '2'
              memory: 4Gi
            requests:
              cpu: '1'
              memory: 1Gi
          volumeMounts:
            - name: redis-cred
              mountPath: /etc/redis/user
            - name: db-cred
              mountPath: /etc/db
            - name: bucket-cred
              mountPath: /etc/bucket
