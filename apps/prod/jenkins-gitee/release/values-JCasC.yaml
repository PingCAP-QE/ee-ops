controller:
  # 'name' is a name of an existing secret in same namespace as jenkins,
  # 'keyName' is the name of one of the keys inside current secret.
  # the 'name' and 'keyName' are concatenated with a '-' in between, so for example:
  # an existing secret "secret-credentials" and a key inside it named "github-password" should be used in Jcasc as ${secret-credentials-github-password}
  # 'name' and 'keyName' must be lowercase RFC 1123 label must consist of lower case alphanumeric characters or '-',
  # and must start and end with an alphanumeric character (e.g. 'my-name',  or '123-abc')
  additionalExistingSecrets:
    # for git clone for private repo.
    - { name: gitee, keyName: git-private-key }
    - { name: gitee, keyName: git-username }
    - { name: gitee, keyName: bot-token }

    # for read-only jenkins user.
    - { name: jenkins-gitee-readonly-user, keyName: username }
    - { name: jenkins-gitee-readonly-user, keyName: password }

    # for ci cache, no need create manually.
    - { name: jenkins-gitee-cache, keyName: region }
    - { name: jenkins-gitee-cache, keyName: bucket }
    - { name: jenkins-gitee-cache, keyName: endpoint }
    - { name: jenkins-gitee-cache, keyName: access-key }
    - { name: jenkins-gitee-cache, keyName: access-secret }
    # for build failure knowledge base, secret created by mongodb helm release, no need create manually.
    - { name: mongodb, keyName: mongodb-root-password }

  additionalSecrets: []
  #  - name: nameOfSecret
  #    value: secretText

  JCasC:
    defaultConfig: true
    # Ignored if authorizationStrategy is defined in controller.JCasC.configScripts
    authorizationStrategy: |-
      roleBased:
        roles:
          global:
            - name: "admin"
              pattern: ".*"
              permissions:
                - "Overall/Administer"
              assignments:
                - "${chart-admin-username}"
            - name: "readonly"
              pattern: ".*"
              permissions:
              - "Overall/Read"
              - "Agent/Connect"          
              - "Build Failure Analyzer/ViewCauses"
              - "Credentials/View"
              - "Job/Read"
              - "Metrics/View"
              - "View/Read"
              assignments:
              - "${jenkins-gitee-readonly-user-username}"

    # for security.
    security:
      globalJobDslSecurityConfiguration:
        useScriptSecurity: false

    securityRealm: |-
      local:
        allowsSignup: false
        enableCaptcha: false
        users:
        - id: "${chart-admin-username}"
          name: "Jenkins Admin"
          password: "${chart-admin-password}"        
        - id: "${jenkins-gitee-readonly-user-username}"
          name: "Read only user"
          password: "${jenkins-gitee-readonly-user-password}"

    # REF Doc: https://github.com/PingCAP-QE/ee-ops/blob/main/charts/jenkins/README.md
    #
    # Notable: if you want delete some key, first please delete the conetnt but keep the key.
    #   after deployed, then create other commit and push to delete the key.
    configScripts:
      #  welcome-message: |
      #    jenkins:
      #      systemMessage: Welcome to our CI\CD server.  This Jenkins is configured and managed 'as code'.
      # Ignored if securityRealm is defined in controller.JCasC.configScripts and
      # ignored if controller.enableXmlConfig=true as controller.securityRealm takes precedence
      # securityRealm: |
      #   jenkins:
      #     securityRealm:
      #       googleOAuth2:
      #         # will read from key `client-id` from secret `google-oauth2`
      #         clientId: "${google-oauth2-client-id}"
      #         # will read from key `client-secret` from secret `google-oauth2`
      #         clientSecret: "${google-oauth2-client-secret}"

      # for credentials, REF Doc: https://github.com/jenkinsci/configuration-as-code-plugin/tree/master/demos/credentials
      credentials: |
        credentials:
          system:
            domainCredentials:
              - domain:
                  name: gitee.com
                  description: github ssh and open api
                credentials:
                  - basicSSHUserPrivateKey:
                      id: gitee-bot-ssh
                      privateKeySource:
                        directEntry:
                          privateKey: ${gitee-git-private-key}
                      scope: GLOBAL
                      username: ${gitee-git-username}
                      usernameSecret: true
                  - string:
                      id: gitee-bot-token
                      description: gitee private token to call api.
                      scope: GLOBAL
                      secret: ${gitee-bot-token}
      # for jobs.
      jobs-dsl: |
        jobs:
          - script: |
              job('seed') {
                description('''
                    Jenkins jobs As Code
                    No need to configure job on Jenkins Web UI anymore.
                ''')
                scm {
                  git {
                    remote {
                      github('PingCAP-QE/ci', 'https')
                    }
                    branch('main')
                  }
                }
                triggers {
                  githubPush()
                }
                steps {
                  jobDsl {
                    targets('gitee/jobs/**/*.groovy')
                    failOnMissingPlugin(false)
                    ignoreMissingFiles(true)
                    ignoreExisting(false)
                    removedJobAction('DELETE')
                    removedConfigFilesAction('DELETE')
                    removedViewAction('DELETE')
                    lookupStrategy('SEED_JOB')
                    sandbox(false)
                  }
                }
              }

              queue('seed')
      github-plugin-config: |
        unclassified:
          gitHubConfiguration:
            apiRateLimitChecker: ThrottleOnOver
          gitHubPluginConfig:
            hookUrl: "https://do.pingcap.net/jenkins-gitee/github-webhook/"
      pipeline-cache: |
        unclassified:
          pipeline-cache:
            region: ${jenkins-gitee-cache-region}
            bucket: ${jenkins-gitee-cache-bucket}
            endpoint: ${jenkins-gitee-cache-endpoint}
            username: ${jenkins-gitee-cache-access-key}
            password: ${jenkins-gitee-cache-access-secret}
            threshold: 100000 # limit to 100GiB
      # for global env variables
      env-vars: |
        jenkins:
          globalNodeProperties:
            - envVars:
                env:
                  - key: "GOPROXY"
                    value: "http://goproxy.apps.svc,https://proxy.golang.org,direct"
      build-failure-analyzer: |
        unclassified:
          buildFailureAnalyzer:
            doNotAnalyzeAbortedJob: true
            gerritTriggerEnabled: false
            globalEnabled: true
            graphsEnabled: false
            knowledgeBase:
              mongoDB:
                dbName: jenkins-failure-pattern
                enableStatistics: true
                host: mongodb.apps.svc
                password: "${mongodb-mongodb-root-password}"
                port: 27017
                successfulLogging: true
                userName: root
            maxLogSize: 0
            metricSquashingEnabled: true
            noCausesEnabled: true
            noCausesMessage: >-
              No problems were identified. If you know why this problem occurred,
              please add a suitable Cause in https://pingcap.feishu.cn/wiki/wikcno79XYpVsvJeiRsMm38b5eh, add a config it.
            nrOfScanThreads: 3
            testResultParsingEnabled: false
            testResultCategories: "UT"
            fallbackCategoriesAsString: unknown
