apiVersion: triggers.tekton.dev/v1beta1
kind: Trigger
metadata:
  name: multi-arch-image-push-on-harbor-pingcap-tiproxy
  labels:
    type: image-push
spec:
  interceptors:
    - name: filter on image repo names
      ref:
        name: cel
      params:
        - name: filter
          value: >-
            body.event_data.repository.repo_full_name in ['pingcap/tiproxy/image']
    - name: filter on image tags
      ref:
        name: "cel"
      params:
        - name: filter
          value: >-
            body.event_data.resources[0].tag.matches('^((master|main)-[0-9a-f]+|v[0-9]+[.][0-9]+[.][0-9]+)$')
  bindings:
    - ref: harbor-image-push
  template:
    spec:
      params:
        - name: image_url
          description: The image full url for pull
        - name: tag
          description: The image tag
      resourcetemplates:
        - apiVersion: tekton.dev/v1beta1
          kind: TaskRun
          metadata:
            generateName: copy-image-tiproxy-
          spec:
            taskRef:
              name: crane-copy
            params:
              - name: src-image-url
                value: "$(tt.params.image_url)"
              - name: dst-image-url
                value: "pingcap/tiproxy:$(tt.params.tag)"
            serviceAccountName: image-releaser
