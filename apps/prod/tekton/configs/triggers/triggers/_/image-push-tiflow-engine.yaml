apiVersion: triggers.tekton.dev/v1beta1
kind: Trigger
metadata:
  name: multi-arch-image-push-on-harboar-tiflow-engine
  labels:
    type: image-push
  namespace: ee-cd
spec:
  bindings:
  - kind: TriggerBinding
    ref: harbor-image-push
  interceptors:
  - name: filter on image repo names
    params:
    - name: filter
      value: body.event_data.repository.repo_full_name in ['pingcap/tiflow/image/tiflow']
    ref:
      kind: ClusterInterceptor
      name: cel
  - name: filter on image tags
    params:
    - name: filter
      value: body.event_data.resources[0].tag.matches('^master$')
    ref:
      kind: ClusterInterceptor
      name: cel
  template:
    spec:
      params:
      - description: The image full url for pull
        name: image_url
      - description: The image tag
        name: tag
      resourcetemplates:
      - apiVersion: tekton.dev/v1beta1
        kind: TaskRun
        metadata:
          generateName: copy-image-gcr-
        spec:
          params:
          - name: src-image-url
            value: $(tt.params.image_url)
          - name: dst-image-url
            value: gcr.io/pingcap-public/tidbcloud/tiflow:$(tt.params.tag)
          serviceAccountName: image-releaser-gcr
          taskRef:
            name: crane-copy
      - apiVersion: tekton.dev/v1beta1
        kind: TaskRun
        metadata:
          generateName: copy-image-gcr-
        spec:
          params:
          - name: src-image-url
            value: $(tt.params.image_url)
          - name: dst-image-url
            value: gcr.io/pingcap-public/tidbcloud/tiflow:latest
          serviceAccountName: image-releaser-gcr
          taskRef:
            name: crane-copy
