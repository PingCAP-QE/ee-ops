---
apiVersion: triggers.tekton.dev/v1beta1
kind: EventListener
metadata:
  name: trigger-groups-listener
spec:
  serviceAccountName: tekton-trigger-eventlistener
  triggerGroups:
    - name: github-pr
      interceptors:
        - name: "filter on eventType"
          ref:
            name: github
          params:
            - name: eventTypes
              value: ["pull_request"]
        - name: "validate PR state and add field"
          ref:
            name: cel
          params:
            - name: filter
              value: body.action in ['opened', 'synchronize', 'reopened']
      triggerSelector:
        namespaceSelector:
          matchNames:
            - ee-cd
        labelSelector:
          matchLabels:
            type: github-pr
    - name: github-branch-push
      interceptors:
        - name: "filter on eventType"
          ref:
            name: github
          params:
            - name: eventTypes
              value: ["push"]
        # "refs/heads/main" => "main"
        - name: shortten the git REF
          ref:
            name: cel
          params:
            - name: overlays
              value:
                - key: short-ref
                  expression: body.ref.replace('refs/heads/', '')
      triggerSelector:
        namespaceSelector:
          matchNames:
            - ee-cd
        labelSelector:
          matchLabels:
            type: github-branch-push
    - name: github-branch-create
      interceptors:
        - name: "filter on eventType"
          ref:
            name: github
          params:
            - name: eventTypes
              value: ["create"]
        - name: "validate branch create"
          ref:
            name: cel
          params:
            - name: filter
              value: body.ref_type == 'branch'
      triggerSelector:
        namespaceSelector:
          matchNames:
            - ee-cd
        labelSelector:
          matchLabels:
            type: github-branch-create
    - name: github-tag-create
      interceptors:
        - name: "filter on eventType"
          ref:
            name: github
          params:
            - name: eventTypes
              value: ["create"]
        - name: "validate tag create"
          ref:
            name: cel
          params:
            - name: filter
              value: body.ref_type == 'tag'
      triggerSelector:
        namespaceSelector:
          matchNames:
            - ee-cd
        labelSelector:
          matchLabels:
            type: github-tag-create
    - name: harbor-image-pushed
      interceptors:
        # event payload:
        # {
        #   "type": "PUSH_ARTIFACT",
        #   "occur_at": 1701140373,
        #   "operator": "robot$release",
        #   "event_data": {
        #     "resources": [
        #         {
        #             "digest": "sha256:14b865676344230458998ebe886d32165264303c38a811a5a6372301ebf45c41",
        #             "tag": "v1",
        #             "resource_url": "hub.pingcap.net/pingcap/hello:v1"
        #         }
        #     ],
        #     "event_data": {
        #         "date_created": 1701140373,
        #         "name": "hello",
        #         "namespace": "pingcap",
        #         "repo_full_name": "pingcap/hello",
        #         "repo_type": "public"
        #     }
        #   }
        # }
        - name: filter on image push events on inner container repositories.
          ref:
            name: "cel"
          params:
            - name: filter
              value: body.type == 'PUSH_ARTIFACT' && body.event_data.repository.namespace in ['pingcap', 'tikv']
        - name: filter on tag images.
          ref:
            name: "cel"
          params:
            - name: filter
              value: >-
                ! body.event_data.resources[0].tag.startsWith('sha256:')
      triggerSelector:
        namespaceSelector:
          matchNames:
            - ee-cd
        labelSelector:
          matchLabels:
            type: image-push
