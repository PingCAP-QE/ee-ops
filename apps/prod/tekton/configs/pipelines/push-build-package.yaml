apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: push-build-package
spec:
  params:
    - name: git-url
      type: string
    - name: git-ref
      type: string
      default: master
    - name: git-revision
      default: master
      type: string
    - name: component
      type: string
      description: |
        compoent name, supports:
        - tidb
        - tikv
        - pd
        - tiflash
        - tiflow

        May be it is an idea to judge it by git-url, but it maybe 
        not a generic way for forked repositories with custom names.
  workspaces:
    - name: dockerconfig
      description: Includes a docker `config.json`
    - name: source
      description: The workspace where the git repo will be cloned.
    - name: gen-build-scripts
      description: The build scripts will be generated in this workspace.
    - name: git-credentials
      description: secret contains ssh private key in `id_rsa` key.
      optional: true
  tasks:
    - name: checkout
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-url)
        - name: revision
          value: $(params.git-revision)
        - name: depth
          value: "0"
        - name: refspec
          value: +refs/heads/$(params.git-ref):refs/remotes/origin/$(params.git-ref)
      workspaces:
        - name: output
          workspace: source
        - name: ssh-directory
          workspace: git-credentials
    - name: get-release-ver
      taskSpec:
        results:
          - name: version
            description: The release version of the git repo
        workspaces:
          - name: source
        steps:
          - name: git-describe
            image: alpine/git:2.40.1
            workingDir: $(workspaces.source.path)
            script: |
              RESULT_VERSION="$(git describe --tags --always --dirty)"
              printf "%s" "${RESULT_VERSION}" > $(results.version.path)
      runAfter:
        - checkout
      workspaces:
        - name: source
          workspace: source
    - name: generate-building-scripts-for-tarballs
      taskRef:
        name: generate-building-scripts-for-tarballs
      runAfter:
        - get-release-ver
      # TODO: currently matrix feature is not support in v0.32.x, we need upgrade the K8S cluster and then upgrade Tekton.
      # matrix:
      #   params:
      #     - name: os
      #       value: [linux, darwin]
      #     - name: arch
      #       value: [amd64, arm64]
      #     - name: profile
      #       value: [release, debug]
      params:
        - name: os
          value: linux
        - name: arch
          value: amd64
        - name: profile
          value: release
        - name: component
          value: "$(params.component)"
        - name: version
          value: "$(tasks.get-release-ver.results.version)"
        - name: git-ref
          value: $(params.git-ref)
        - name: git-sha
          value: $(params.git-revision)
      workspaces:
        - name: output
          workspace: gen-build-scripts
    - name: generate-building-scripts-for-images
      taskRef:
        name: generate-building-scripts-for-images
      runAfter:
        - get-release-ver
      # TODO: currently matrix feature is not support in v0.32.x, we need upgrade the K8S cluster and then upgrade Tekton.
      # matrix:
      #   params:
      #     - name: os
      #       value: [linux, darwin]
      #     - name: arch
      #       value: [amd64, arm64]
      #     - name: profile
      #       value: [release, debug]
      params:
        - name: os
          value: linux
        - name: arch
          value: amd64
        - name: profile
          value: release
        - name: component
          value: "$(params.component)"
        - name: version
          value: "$(tasks.get-release-ver.results.version)"
        - name: git-ref
          value: $(params.git-ref)
        - name: git-sha
          value: $(params.git-revision)
      workspaces:
        - name: output
          workspace: gen-build-scripts
    - name: run-building-scripts-for-tarballs
      taskRef:
        # TODO: is there a sulution to push for multi platforms.
        name: run-building-scripts-for-tarballs
      runAfter:
        - generate-building-scripts-for-tarballs
      # TODO: currently matrix feature is not support in v0.32.x, we need upgrade the K8S cluster and then upgrade Tekton.
      params:
        - name: release-dir
          value: build
        - name: run-script-file
          value: build-package-artifacts.sh
        - name: need-build
          value: "true"
        - name: build-image
          # value: ghcr.io/pingcap-qe/ci/release-build-base:v20231029-b8b8d34-go1.21
          value: ghcr.io/pingcap-qe/ci/release-build-base:v20231107-4086b32-go1.21_linux_amd64
      workspaces:
        - name: source
          workspace: source
        - name: build-scripts
          workspace: gen-build-scripts
    - name: puash-tarballs-to-oci
      taskRef:
        name: oras-push
      runAfter:
        - run-building-scripts-for-tarballs
      # TODO: currently matrix feature is not support in v0.32.x, we need upgrade the K8S cluster and then upgrade Tekton.
      params:
        - name: artifacts
          value: "*.tar.gz"
        - name: context
          value: build
        - name: destination
          # TODO: upload in the run task.
          value: hub.pingcap.net/ee-debug/hello-$(params.component):$(tasks.get-release-ver.results.version)
      workspaces:
        - name: source
          workspace: source
        - name: build-scripts
          workspace: gen-build-scripts          
    - name: run-building-scripts-for-images
      taskRef:
        # TODO: can we skaffold to make it simpler?
        name: run-building-scripts-for-images
      runAfter:
        - generate-building-scripts-for-images
        - run-building-scripts-for-tarballs
      # TODO: currently matrix feature is not support in v0.32.x, we need upgrade the K8S cluster and then upgrade Tekton.
      params:
        - name: release-dir
          value: build
        - name: run-script-file
          value: build-package-images.sh
        - name: need-build
          value: "false"
        - name: build-image
          value: gcr.io/kaniko-project/executor:debug
      workspaces:
        - name: source
          workspace: source
        - name: build-scripts
          workspace: gen-build-scripts
        - name: dockerconfig
          workspace: dockerconfig
