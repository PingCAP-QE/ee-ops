apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: add-image-major-tag
spec:
  params:
    - name: image_url
      description: The image full url for pull
  steps:
    - name: add-nightly-tag
      image: alpine
      script: |
        pushed_repo="$(echo $(params.image_url) | cut -d ':' -f 1)"
        pushed_tag="$(echo $(params.image_url) | cut -d ':' -f 2)"

        # Check if the tag is "main" or "master" and add "nightly"
        if [ "$pushed_tag" = "main" ] || [ "$pushed_tag" = "master" ]; then
          echo "ðŸš€ Adding nightly tag"
          oras tag $(params.image_url) nightly
          echo "âœ… Added nightly tag"
        else
          echo "ðŸ¤š Tag is not main or master"
        fi
    
    - name: add-latest-tag
      image: alpine
      script: |
          pushed_repo="$(echo $(params.image_url) | cut -d ':' -f 1)"
          pushed_tag="$(echo $(params.image_url) | cut -d ':' -f 2)"

          # Check if the tag is the latest version and add "latest"
          if [ "$(echo $TAG | grep -E '^v\d+\.\d+\.+\d+$')"  ]; then
            echo "Checking if tag is the latest version"
            # Retrieve existing tags
            EXISTING_TAGS=$(oras repo tags ${pushed_repo} | grep -E '^v\d+\.\d+\.+\d+$')

            # Determine if the tag is the latest version
            LATEST_TAG=$(echo "$EXISTING_TAGS" | sort -V | tail -n 1)
            if [ "$LATEST_TAG" == "$pushed_tag" ]; then
              echo "ðŸš€ Adding latest tag"
              oras tag $(params.image_url) latest
              echo "âœ… Added latest tag"
            else
              echo "ðŸ¤š Tag is not the latest version"
            fi
          else
            echo "Tag is not a version tag"
          fi
