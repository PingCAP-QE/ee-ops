apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: multi-arch-image-pre-collect
spec:
  description: |
    The working flow:
    1. list the tags for the repo.
    2. filter the single arch tags.
    3. get the digest of the tags.
    4. the tags should follow the standard format:
      - master-00595b4-release_linux_amd64 => master-00595b4-release => master-00595b4 => master
      - master-00595b4-release-linux-arm64 => master-00595b4-release => master-00595b4 => master
      - master-00595b4-release_arm64       => master-00595b4-release => master-00595b4 => master
      - master-00595b4-release-arm64       => master-00595b4-release => master-00595b4 => master
  params:
    - name: image_url
      description: The full url of the pushed image, contain the tag part.
    - name: release_tag_suffix
      default: "release"
  results:
    - name: repo
      description: image repo
    - name: tags
      description: tags to push
    - name: digests
      type: array
      description: |
        image digests list for different platforms, element format is
        <platform> => <digest>
  steps:
    - name: prepare
      image: ghcr.io/pingcap-qe/cd/utils/release:5d33328
      script: |
        #! /usr/bin/env bash

        set -exo pipefail

        :> $(results.digests.path)
        :> $(results.repo.path)
        :> $(results.tags.path)

        # steps:
        # 1. check the pushed tag, if not existed, step will fail.
        oras repo tags $(params.image_url)

        # 2. compute the mult-arch tags and digests
        pushed_repo="$(echo $(params.image_url) | cut -d ':' -f 1)"
        pushed_tag="$(echo $(params.image_url) | cut -d ':' -f 2)"
        tag=$(\
          echo "$pushed_tag" | \
          sed -E 's/[-_](amd64|arm64)$//g' | \
          sed -E 's/[-_]linux$//g' \
        )

        # repo
        printf "%s" "$pushed_repo" > $(results.repo.path)

        # tags
        tags="$tag"
        tags="$tags $(echo $tag | sed -E 's/[-_]$(params.release_tag_suffix)$//g')"
        printf "%s" "$tags" > $(results.tags.path)


        # digest map
        jq -n '[]' > $(results.digests.path)
        for t in `oras repo tags $pushed_repo | grep -E "${tag}[-_].*[-_](amd64|arm64)$"`; do
          manifest-tool inspect --raw "${pushed_repo}:$t" > manifest.json
          platform=`jq -r '.os + "/" + .architecture' manifest.json`
          digest=`jq -r '.digest' manifest.json`

          cp $(results.digests.path) temp.json && \
          jq -n ". += [\"$platform => $digest\"]" temp.json > $(results.digests.path) && \
          rm -f temp.json
        done
      workingDir: /workspace
  workspaces:
    - description: Includes a docker `config.json`
      mountPath: /root/.docker
      name: dockerconfig
      optional: true
