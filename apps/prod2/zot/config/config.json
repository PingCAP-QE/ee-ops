{
  "log": { "level": "debug" },
  "storage": {
    "rootDirectory": "/var/lib/registry",
    "remoteCache": true,
    "commit": true,
    "dedupe": true,
    "gc": true,
    "gcDelay": "1h",
    "gcInterval": "24h",
    "storageDriver": {
      "name": "s3",
      "rootdirectory": "/zot",
      "secure": true,
      "skipverify": false,
      "forcepathstyle": false,
      "region": "${S3_REGION}",
      "regionendpoint": "${S3_REGION_ENDPOINT}",
      "bucket": "${S3_BUCKET}",
      "accesskey": "${S3_ACCESS_KEY}",
      "secretkey": "${S3_SECRET_KEY}"
    },
    "cacheDriver": {
      "name": "redis",
      "url": "redis://:${REDIS_PASSWORD}@redis-master:6379/0?dial_timeout=3&read_timeout=6s",
      "keyprefix": "zot"
    }
  },
  "http": {
    "address": "0.0.0.0",
    "port": "5000",
    "compat": ["docker2s2"],
    "externalUrl": "${EXTERNAL_URL}",
    "realm": "zot",
    "auth": {
      "failDelay": 5,
      "htpasswd": {
        "path": "/secret/htpasswd"
      },
      "sessionKeysFile": "/secret/sessionKeys.json",
      "apikey": true,
      "openid": {
        "providers": {
          "github": {
            "clientid": "${GITHUB_CLIENT_ID}",
            "clientsecret": "${GITHUB_CLIENT_SECRET}",
            "scopes": ["read:org", "user", "repo"]
          },
          "google": {
            "issuer": "https://accounts.google.com",
            "clientid": "${GOOGLE_CLIENT_ID}",
            "clientsecret": "${GOOGLE_CLIENT_SECRET}",
            "scopes": ["openid", "email"]
          }
        }
      }
    },
    "accessControl": {
      "repositories": {
        "**": {
          "anonymousPolicy": ["read"],
          "defaultPolicy": ["read"]
        }
      },
      "adminPolicy": {
        "users": ["admin"],
        "actions": ["read", "create", "update", "delete"]
      }
    },
    "ratelimit": {
      "rate": 10,
      "methods": [
        {
          "method": "GET",
          "rate": 5
        }
      ]
    }
  },
  "extensions": {
    "ui": {
      "enable": true
    },
    "search": {
      "enable": true
    },
    "sync": {
      "enable": true,
      "downloadDir": "/tmp/zot",
      "credentialsFile": "${ZOT_SYNC_AUTH_JSON_FILEPATH}",
      "registries": [
        {
          "urls": ["https://us-docker.pkg.dev"],
          "preserveDigest": true,
          "content": [
            {
              "prefix": "/pingcap-testing-account/dev/**",
              "destination": "/mirrors/dev",
              "stripPrefix": true
            }
          ],
          "onDemand": true,
          "tlsVerify": true
        },
        {
          "urls": ["https://us-docker.pkg.dev"],
          "preserveDigest": true,
          "content": [
            {
              "prefix": "/pingcap-testing-account/tidbx/**",
              "destination": "/mirrors/tidbx",
              "stripPrefix": true
            }
          ],
          "onDemand": true,
          "tlsVerify": true
        },
        {
          "urls": ["https://us-docker.pkg.dev"],
          "preserveDigest": true,
          "content": [
            {
              "prefix": "/pingcap-testing-account/tidbx/**",
              "tags": {
                "regex": "^(dedicated|master|main|release-[0-9]+[.][0-9]+|release-nextgen-[0-9]+|v[0-9]+[.][0-9]+[.][0-9]+-pre)-(enterprise|failpoint|next-gen)?$"
              },
              "destination": "/mirrors/tidbx",
              "stripPrefix": true
            }
          ],
          "onDemand": false,
          "pollInterval": "1h",
          "tlsVerify": true
        },
        {
          "urls": [
            "https://hub.pingcap.net",
            "https://us-docker.pkg.dev/pingcap-testing-account/hub"
          ],
          "preserveDigest": true,
          "content": [
            {
              "prefix": "/pingcap/**",
              "destination": "/mirrors/hub/pingcap",
              "stripPrefix": true
            }
          ],
          "onDemand": true,
          "tlsVerify": true
        },
        {
          "urls": [
            "https://hub.pingcap.net",
            "https://us-docker.pkg.dev/pingcap-testing-account/hub"
          ],
          "preserveDigest": true,
          "content": [
            {
              "prefix": "/pingcap/**",
              "tags": {
                "regex": "^(master|main|release-[0-9]+[.][0-9]+|v[0-9]+[.][0-9]+[.][0-9]+-pre)-(enterprise|failpoint)?$"
              },
              "destination": "/mirrors/hub/pingcap",
              "stripPrefix": true
            }
          ],
          "onDemand": false,
          "pollInterval": "1h",
          "tlsVerify": true
        },
        {
          "urls": [
            "https://hub.pingcap.net",
            "https://us-docker.pkg.dev/pingcap-testing-account/hub"
          ],
          "preserveDigest": true,
          "content": [
            {
              "prefix": "/tikv/**",
              "destination": "/mirrors/hub/tikv",
              "stripPrefix": true
            }
          ],
          "onDemand": true,
          "tlsVerify": true
        },
        {
          "urls": [
            "https://hub.pingcap.net",
            "https://us-docker.pkg.dev/pingcap-testing-account/hub"
          ],
          "preserveDigest": true,
          "content": [
            {
              "prefix": "/tikv/**",
              "tags": {
                "regex": "^(master|main|release-[0-9]+[.][0-9]+|v[0-9]+[.][0-9]+[.][0-9]+-pre)-(enterprise|failpoint)?$"
              },
              "destination": "/mirrors/hub/tikv",
              "stripPrefix": true
            }
          ],
          "onDemand": false,
          "pollInterval": "1h",
          "tlsVerify": true
        }
      ]
    },
    "scrub": {
      "enable": true,
      "interval": "120h"
    },
    "mgmt": {
      "enable": true
    },
    "events": {
      "enable": true,
      "sinks": [
        {
          "type": "http",
          "address": "${ZOT_EVENT_SINKER_URL}",
          "timeout": "5s",
          "credentials": {},
          "headers": {}
        }
      ]
    }
  }
}
