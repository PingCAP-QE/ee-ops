# Copyright 2022 TriggerMesh Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: triggermesh-namespaced-admin
  labels:
    rbac.authorization.k8s.io/aggregate-to-admin: "true"
    app.kubernetes.io/part-of: triggermesh
rules:
  - apiGroups:
      - flow.triggermesh.io
      - routing.triggermesh.io
      - sources.triggermesh.io
      - targets.triggermesh.io
    resources: ["*"]
    verbs: ["*"]
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: triggermesh-namespaced-edit
  labels:
    rbac.authorization.k8s.io/aggregate-to-edit: "true"
    app.kubernetes.io/part-of: triggermesh
rules:
  - apiGroups:
      - flow.triggermesh.io
      - routing.triggermesh.io
      - sources.triggermesh.io
      - targets.triggermesh.io
    resources: ["*"]
    verbs:
      - create
      - update
      - patch
      - delete
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: triggermesh-namespaced-view
  labels:
    rbac.authorization.k8s.io/aggregate-to-view: "true"
    app.kubernetes.io/part-of: triggermesh
rules:
  - apiGroups:
      - flow.triggermesh.io
      - routing.triggermesh.io
      - sources.triggermesh.io
      - targets.triggermesh.io
    resources: ["*"]
    verbs:
      - get
      - list
      - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: triggermesh-webhook
  labels:
    app.kubernetes.io/part-of: triggermesh
rules:
  # Routing admin
  - apiGroups:
      - routing.triggermesh.io
    resources:
      - filters
      - splitters
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
  # Routing statuses update
  - apiGroups:
      - routing.triggermesh.io
    resources:
      - splitters/status
      - filters/status
    verbs:
      - update
  - apiGroups:
      - flow.triggermesh.io
    resources:
      - xslttransformations
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
  - apiGroups:
      - flow.triggermesh.io
    resources:
      - xslttransformations/status
    verbs:
      - update
  # Events admin
  - apiGroups:
      - ''
    resources:
      - events
      - configmaps
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
  # For manipulating certs into secrets.
  - apiGroups:
      - ''
    resources:
      - secrets
    verbs:
      - get
      - create
      - update
      - list
      - watch
  # Validation webhook gets system namespace to use it as an owner.
  - apiGroups:
      - ''
    resources:
      - namespaces
    verbs:
      - get
  # For actually registering our webhook.
  - apiGroups:
      - admissionregistration.k8s.io
    resources:
      - mutatingwebhookconfigurations
      - validatingwebhookconfigurations
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
  # Acquire leases for leader election
  - apiGroups:
      - coordination.k8s.io
    resources:
      - leases
    verbs:
      - get
      - create
      - update
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: triggermesh-controller
  labels:
    app.kubernetes.io/part-of: triggermesh
rules:
  # Record Kubernetes events
  - apiGroups:
      - ''
    resources:
      - events
    verbs:
      - create
      - patch
      - update
  # Manage receive-adapters
  - apiGroups:
      - apps
    resources:
      - deployments
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - delete
      - patch
  - apiGroups:
      - serving.knative.dev
    resources:
      - services
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - delete
      - patch
  # Read reconciled TriggerMesh resources and update their statuses
  - apiGroups:
      - sources.triggermesh.io
    resources:
      - awscloudwatchlogssources
      - awscloudwatchsources
      - awscodecommitsources
      - awscognitoidentitysources
      - awscognitouserpoolsources
      - awsdynamodbsources
      - awseventbridgesources
      - awskinesissources
      - awsperformanceinsightssources
      - awss3sources
      - awssnssources
      - awssqssources
      - azureactivitylogssources
      - azureblobstoragesources
      - azureeventgridsources
      - azureeventhubssources
      - azureiothubsources
      - azurequeuestoragesources
      - azureservicebusqueuesources
      - azureservicebussources
      - azureservicebustopicsources
      - cloudeventssources
      - googlecloudauditlogssources
      - googlecloudbillingsources
      - googlecloudpubsubsources
      - googlecloudsourcerepositoriessources
      - googlecloudstoragesources
      - httppollersources
      - ibmmqsources
      - kafkasources
      - mongodbsources
      - ocimetricssources
      - salesforcesources
      - slacksources
      - solacesources
      - twiliosources
      - webhooksources
      - zendesksources
    verbs:
      - list
      - watch
      - get
  - apiGroups:
      - sources.triggermesh.io
    resources:
      - awscloudwatchlogssources/status
      - awscloudwatchsources/status
      - awscodecommitsources/status
      - awscognitoidentitysources/status
      - awscognitouserpoolsources/status
      - awsdynamodbsources/status
      - awseventbridgesources/status
      - awskinesissources/status
      - awsperformanceinsightssources/status
      - awss3sources/status
      - awssnssources/status
      - awssqssources/status
      - azureactivitylogssources/status
      - azureblobstoragesources/status
      - azureeventgridsources/status
      - azureeventhubssources/status
      - azureiothubsources/status
      - azurequeuestoragesources/status
      - azureservicebusqueuesources/status
      - azureservicebussources/status
      - azureservicebustopicsources/status
      - cloudeventssources/status
      - googlecloudauditlogssources/status
      - googlecloudbillingsources/status
      - googlecloudpubsubsources/status
      - googlecloudsourcerepositoriessources/status
      - googlecloudstoragesources/status
      - httppollersources/status
      - ibmmqsources/status
      - kafkasources/status
      - mongodbsources/status
      - ocimetricssources/status
      - salesforcesources/status
      - slacksources/status
      - solacesources/status
      - twiliosources/status
      - webhooksources/status
      - zendesksources/status
    verbs:
      - update
  - apiGroups:
      - targets.triggermesh.io
    resources:
      - awscomprehendtargets
      - awsdynamodbtargets
      - awseventbridgetargets
      - awskinesistargets
      - awslambdatargets
      - awss3targets
      - awssnstargets
      - awssqstargets
      - azureeventhubstargets
      - azuresentineltargets
      - azureservicebustargets
      - cloudeventstargets
      - datadogtargets
      - elasticsearchtargets
      - googlecloudfirestoretargets
      - googlecloudpubsubtargets
      - googlecloudstoragetargets
      - googlecloudworkflowstargets
      - googlesheettargets
      - httptargets
      - ibmmqtargets
      - jiratargets
      - kafkatargets
      - logzmetricstargets
      - logztargets
      - mongodbtargets
      - oracletargets
      - salesforcetargets
      - sendgridtargets
      - slacktargets
      - solacetargets
      - splunktargets
      - twiliotargets
      - zendesktargets
    verbs:
      - list
      - watch
      - get
  - apiGroups:
      - targets.triggermesh.io
    resources:
      - awscomprehendtargets/status
      - awsdynamodbtargets/status
      - awseventbridgetargets/status
      - awskinesistargets/status
      - awslambdatargets/status
      - awss3targets/status
      - awssnstargets/status
      - awssqstargets/status
      - azureeventhubstargets/status
      - azuresentineltargets/status
      - azureservicebustargets/status
      - cloudeventstargets/status
      - datadogtargets/status
      - elasticsearchtargets/status
      - googlecloudfirestoretargets/status
      - googlecloudpubsubtargets/status
      - googlecloudstoragetargets/status
      - googlecloudworkflowstargets/status
      - googlesheettargets/status
      - httptargets/status
      - ibmmqtargets/status
      - jiratargets/status
      - kafkatargets/status
      - logzmetricstargets/status
      - logztargets/status
      - mongodbtargets/status
      - oracletargets/status
      - salesforcetargets/status
      - sendgridtargets/status
      - slacktargets/status
      - solacetargets/status
      - splunktargets/status
      - twiliotargets/status
      - zendesktargets/status
    verbs:
      - update
  - apiGroups:
      - flow.triggermesh.io
    resources:
      - jqtransformations
      - synchronizers
      - transformations
      - xmltojsontransformations
      - xslttransformations
    verbs:
      - list
      - watch
      - get
  - apiGroups:
      - flow.triggermesh.io
    resources:
      - jqtransformations/status
      - synchronizers/status
      - transformations/status
      - xmltojsontransformations/status
      - xslttransformations/status
    verbs:
      - update
  - apiGroups:
      - extensions.triggermesh.io
    resources:
      - functions
    verbs:
      - list
      - watch
      - get
  - apiGroups:
      - extensions.triggermesh.io
    resources:
      - functions/status
    verbs:
      - update
  - apiGroups:
      - routing.triggermesh.io
    resources:
      - filters
      - splitters
    verbs:
      - list
      - watch
      - get
  - apiGroups:
      - routing.triggermesh.io
    resources:
      - filters/status
      - splitters/status
    verbs:
      - update
  # Ensure compatibility with the OwnerReferencesPermissionEnforcement Admission Controller
  # https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#ownerreferencespermissionenforcement
  - apiGroups:
      - sources.triggermesh.io
    resources:
      - awscloudwatchlogssources/finalizers
      - awscloudwatchsources/finalizers
      - awscodecommitsources/finalizers
      - awscognitoidentitysources/finalizers
      - awscognitouserpoolsources/finalizers
      - awsdynamodbsources/finalizers
      - awseventbridgesources/finalizers
      - awskinesissources/finalizers
      - awsperformanceinsightssources/finalizers
      - awss3sources/finalizers
      - awssnssources/finalizers
      - awssqssources/finalizers
      - azureactivitylogssources/finalizers
      - azureblobstoragesources/finalizers
      - azureeventgridsources/finalizers
      - azureeventhubssources/finalizers
      - azureiothubsources/finalizers
      - azurequeuestoragesources/finalizers
      - azureservicebusqueuesources/finalizers
      - azureservicebussources/finalizers
      - azureservicebustopicsources/finalizers
      - cloudeventssources/finalizers
      - googlecloudauditlogssources/finalizers
      - googlecloudbillingsources/finalizers
      - googlecloudpubsubsources/finalizers
      - googlecloudsourcerepositoriessources/finalizers
      - googlecloudstoragesources/finalizers
      - httppollersources/finalizers
      - ibmmqsources/finalizers
      - kafkasources/finalizers
      - mongodbsources/finalizers
      - ocimetricssources/finalizers
      - salesforcesources/finalizers
      - slacksources/finalizers
      - solacesources/finalizers
      - twiliosources/finalizers
      - webhooksources/finalizers
      - zendesksources/finalizers
    verbs:
      - update
  - apiGroups:
      - targets.triggermesh.io
    resources:
      - awscomprehendtargets/finalizers
      - awsdynamodbtargets/finalizers
      - awseventbridgetargets/finalizers
      - awskinesistargets/finalizers
      - awslambdatargets/finalizers
      - awss3targets/finalizers
      - awssnstargets/finalizers
      - awssqstargets/finalizers
      - azureeventhubstargets/finalizers
      - azuresentineltargets/finalizers
      - azureservicebustargets/finalizers
      - cloudeventstargets/finalizers
      - datadogtargets/finalizers
      - elasticsearchtargets/finalizers
      - googlecloudfirestoretargets/finalizers
      - googlecloudpubsubtargets/finalizers
      - googlecloudstoragetargets/finalizers
      - googlecloudworkflowstargets/finalizers
      - googlesheettargets/finalizers
      - httptargets/finalizers
      - ibmmqtargets/finalizers
      - jiratargets/finalizers
      - kafkatargets/finalizers
      - logzmetricstargets/finalizers
      - logztargets/finalizers
      - mongodbtargets/finalizers
      - oracletargets/finalizers
      - salesforcetargets/finalizers
      - sendgridtargets/finalizers
      - slacktargets/finalizers
      - solacetargets/finalizers
      - splunktargets/finalizers
      - twiliotargets/finalizers
      - zendesktargets/finalizers
    verbs:
      - update
  - apiGroups:
      - flow.triggermesh.io
    resources:
      - jqtransformations/finalizers
      - synchronizers/finalizers
      - transformations/finalizers
      - xmltojsontransformations/finalizers
      - xslttransformations/finalizers
    verbs:
      - update
  - apiGroups:
      - extensions.triggermesh.io
    resources:
      - functions/finalizers
    verbs:
      - update
  - apiGroups:
      - routing.triggermesh.io
    resources:
      - filters/finalizers
      - splitters/finalizers
    verbs:
      - update
  # Set finalizers
  - apiGroups:
      - sources.triggermesh.io
    resources:
      - awseventbridgesources
      - awss3sources
      - awssnssources
      - azureactivitylogssources
      - azureblobstoragesources
      - azureeventgridsources
      - azureservicebusqueuesources
      - azureservicebussources
      - azureservicebustopicsources
      - googlecloudauditlogssources
      - googlecloudbillingsources
      - googlecloudpubsubsources
      - googlecloudsourcerepositoriessources
      - googlecloudstoragesources
      - zendesksources
    verbs:
      - patch
  # Manage resource-specific ServiceAccounts and RoleBindings
  - apiGroups:
      - ''
    resources:
      - serviceaccounts
      - serviceaccounts/finalizers
    verbs:
      - list
      - watch
      - create
      - update
      - delete
  - apiGroups:
      - rbac.authorization.k8s.io
    resources:
      - rolebindings
    verbs:
      - list
      - watch
      - create
  - apiGroups:
      - rbac.authorization.k8s.io
    resources:
      - rolebindings
    # Only multi-tenant components receive permissions via RoleBindings to
    # interact with the Kubernetes API.
    resourceNames:
      - awssnssource-adapter
      - zendesksource-adapter
      - filter-adapter
      - splitter-adapter
    verbs:
      - update
  # Read credentials
  - apiGroups:
      - ''
    resources:
      - secrets
    verbs:
      - get
  # Required by Function controller to store, and mount user's code
  - apiGroups:
      - ''
    resources:
      - configmaps
    verbs:
      - get
      - list
      - create
      - update
      - delete
      - patch
      - watch
  # Read controller configurations
  - apiGroups:
      - ''
    resources:
      - configmaps
    verbs:
      - list
      - watch
  - apiGroups:
      - ''
    resources:
      - configmaps
    resourceNames:
      - config-logging
      - config-observability
      - config-leader-election
    verbs:
      - get
  # Acquire leases for leader election
  - apiGroups:
      - coordination.k8s.io
    resources:
      - leases
    verbs:
      - get
      - create
      - update
  # Observe status of Pods and their ancestors
  - apiGroups:
      - ''
    resources:
      - pods
    verbs:
      - list
      - watch
  - apiGroups:
      - apps
    resources:
      - replicasets
    verbs:
      - list
      - watch
---
# This role is used to grant receive adapters read-only access to per-component
# configurations such as logging, observability and tracing.
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: triggermesh-config-watcher
  labels:
    app.kubernetes.io/part-of: triggermesh
rules:
  - apiGroups:
      - ''
    resources:
      - configmaps
    verbs:
      - list
      - watch
      - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: awssnssource-adapter
  labels:
    app.kubernetes.io/part-of: triggermesh
rules:
  # Record Kubernetes events
  - apiGroups:
      - ''
    resources:
      - events
    verbs:
      - create
      - patch
      - update
  # Read Source resources and update their statuses
  - apiGroups:
      - sources.triggermesh.io
    resources:
      - awssnssources
    verbs:
      - list
      - watch
  - apiGroups:
      - sources.triggermesh.io
    resources:
      - awssnssources/status
    verbs:
      - patch
  # Read credentials
  - apiGroups:
      - ''
    resources:
      - secrets
    verbs:
      - get
  # Acquire leases for leader election
  - apiGroups:
      - coordination.k8s.io
    resources:
      - leases
    verbs:
      - get
      - create
      - update
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: zendesksource-adapter
  labels:
    app.kubernetes.io/part-of: triggermesh
rules:
  # Record Kubernetes events
  - apiGroups:
      - ''
    resources:
      - events
    verbs:
      - create
      - patch
      - update
  # Read Source resources
  - apiGroups:
      - sources.triggermesh.io
    resources:
      - zendesksources
    verbs:
      - list
      - watch
  # Read credentials
  - apiGroups:
      - ''
    resources:
      - secrets
    verbs:
      - get
  # Acquire leases for leader election
  - apiGroups:
      - coordination.k8s.io
    resources:
      - leases
    verbs:
      - get
      - create
      - update
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: filter-adapter
  labels:
    app.kubernetes.io/part-of: triggermesh
rules:
  - apiGroups:
      - ''
    resources:
      - events
    verbs:
      - create
      - patch
      - update
  - apiGroups:
      - ''
    resources:
      - configmaps
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - routing.triggermesh.io
    resources:
      - filters
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - coordination.k8s.io
    resources:
      - leases
    verbs:
      - get
      - create
      - update
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: splitter-adapter
  labels:
    app.kubernetes.io/part-of: triggermesh
rules:
  - apiGroups:
      - ''
    resources:
      - events
    verbs:
      - create
      - patch
      - update
  - apiGroups:
      - ''
    resources:
      - configmaps
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - routing.triggermesh.io
    resources:
      - splitters
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - coordination.k8s.io
    resources:
      - leases
    verbs:
      - get
      - create
      - update
---
# This role provides readonly access to "Source" duck types.
# All the rules it contains get aggregated into the "source-observer" ClusterRole provided by Knative Eventing.
# see https://github.com/knative/eventing/blob/release-0.26/docs/spec/sources.md#source-rbac
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: triggermesh-source-observer
  labels:
    app.kubernetes.io/part-of: triggermesh
    duck.knative.dev/source: 'true'
rules:
  - apiGroups:
      - sources.triggermesh.io
    resources:
      - awscloudwatchlogssources
      - awscloudwatchsources
      - awscodecommitsources
      - awscognitoidentitysources
      - awscognitouserpoolsources
      - awsdynamodbsources
      - awseventbridgesources
      - awskinesissources
      - awsperformanceinsightssources
      - awss3sources
      - awssnssources
      - awssqssources
      - azureactivitylogssources
      - azureblobstoragesources
      - azureeventgridsources
      - azureeventhubssources
      - azureiothubsources
      - azurequeuestoragesources
      - azureservicebusqueuesources
      - azureservicebussources
      - azureservicebustopicsources
      - cloudeventssources
      - googlecloudauditlogssources
      - googlecloudbillingsources
      - googlecloudpubsubsources
      - googlecloudsourcerepositoriessources
      - googlecloudstoragesources
      - httppollersources
      - ibmmqsources
      - kafkasources
      - mongodbsources
      - ocimetricssources
      - salesforcesources
      - slacksources
      - solacesources
      - twiliosources
      - webhooksources
      - zendesksources
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - sources.triggermesh.io
    resources:
      - awscloudwatchlogssources/finalizers
      - awscloudwatchsources/finalizers
      - awscodecommitsources/finalizers
      - awscognitoidentitysources/finalizers
      - awscognitouserpoolsources/finalizers
      - awsdynamodbsources/finalizers
      - awskinesissources/finalizers
      - awsperformanceinsightssources/finalizers
      - awss3sources/finalizers
      - awssnssources/finalizers
      - awssqssources/finalizers
      - azureactivitylogssources/finalizers
      - azureblobstoragesources/finalizers
      - azureeventgridsources/finalizers
      - azureeventhubssources/finalizers
      - azureiothubsources/finalizers
      - azurequeuestoragesources/finalizers
      - azureservicebusqueuesources/finalizers
      - azureservicebussources/finalizers
      - azureservicebustopicsources/finalizers
      - googlecloudauditlogssources/finalizers
      - googlecloudbillingsources/finalizers
      - googlecloudpubsubsources/finalizers
      - googlecloudsourcerepositoriessources/finalizers
      - googlecloudstoragesources/finalizers
    verbs:
      - update
---
# This aggregated role grants read-only access to Addressables.
# It is intended mainly to allow sink resolvers to resolve URLs from object references.
#
# NOTE: This same role can also be found in Knative Eventing. It is duplicated here to allow running TriggerMesh in a
# cluster which doesn't have Knative Eventing deployed.
# Source:
#   https://github.com/knative/eventing/blob/knative-v1.1.0/config/core/roles/addressable-resolvers-clusterrole.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: addressable-resolver
  labels:
    app.kubernetes.io/part-of: triggermesh
aggregationRule:
  clusterRoleSelectors:
    - matchLabels:
        duck.knative.dev/addressable: 'true'
rules: [] # Rules are automatically filled in by the Kubernetes controller manager.
---
# This role provides readonly access to "Addressable" duck types.
# All the rules it contains get aggregated into the "addressable-resolver" ClusterRole.
# https://github.com/knative/eventing/blob/release-0.26/config/core/roles/addressable-resolvers-clusterrole.yaml#L15-L28
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: triggermesh-addressable-resolver
  labels:
    app.kubernetes.io/part-of: triggermesh
    duck.knative.dev/addressable: 'true'
rules:
  - apiGroups:
      - targets.triggermesh.io
    resources:
      - awscomprehendtargets
      - awsdynamodbtargets
      - awseventbridgetargets
      - awskinesistargets
      - awslambdatargets
      - awss3targets
      - awssnstargets
      - awssqstargets
      - azureeventhubstargets
      - azuresentineltargets
      - azureservicebustargets
      - cloudeventstargets
      - datadogtargets
      - elasticsearchtargets
      - googlecloudfirestoretargets
      - googlecloudpubsubtargets
      - googlecloudstoragetargets
      - googlecloudworkflowstargets
      - googlesheettargets
      - httptargets
      - ibmmqtargets
      - jiratargets
      - kafkatargets
      - logzmetricstargets
      - logztargets
      - mongodbtargets
      - oracletargets
      - salesforcetargets
      - sendgridtargets
      - slacktargets
      - solacetargets
      - splunktargets
      - twiliotargets
      - zendesktargets
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - flow.triggermesh.io
    resources:
      - jqtransformations
      - synchronizers
      - transformations
      - xmltojsontransformations
      - xslttransformations
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - extensions.triggermesh.io
    resources:
      - functions
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - routing.triggermesh.io
    resources:
      - filters
      - splitters
    verbs:
      - get
      - list
      - watch
  # Allow resolving URLs of a few additional common types which are not supplied by TriggerMesh.
  - apiGroups:
      - ''
    resources:
      - services
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - serving.knative.dev
    resources:
      - routes
      - services
    verbs:
      - get
      - list
      - watch
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: triggermesh-controller
  namespace: triggermesh
  labels:
    app.kubernetes.io/part-of: triggermesh
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: triggermesh-webhook
  namespace: triggermesh
  labels:
    app.kubernetes.io/part-of: triggermesh
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: triggermesh-webhook
  labels:
    app.kubernetes.io/part-of: triggermesh
subjects:
  - kind: ServiceAccount
    name: triggermesh-webhook
    namespace: triggermesh
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: triggermesh-webhook
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: triggermesh-controller
  labels:
    app.kubernetes.io/part-of: triggermesh
subjects:
  - kind: ServiceAccount
    name: triggermesh-controller
    namespace: triggermesh
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: triggermesh-controller
---
# Permissions not required by controllers directly, but granted to
# receive-adapters via RoleBindings.
#
# Without them, the following error is thrown:
#   "attempting to grant RBAC permissions not currently held"
#
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: awssnssource-adapter
  labels:
    app.kubernetes.io/part-of: triggermesh
subjects:
  - kind: ServiceAccount
    name: triggermesh-controller
    namespace: triggermesh
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: awssnssource-adapter
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: zendesksource-adapter
  labels:
    app.kubernetes.io/part-of: triggermesh
subjects:
  - kind: ServiceAccount
    name: triggermesh-controller
    namespace: triggermesh
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: zendesksource-adapter
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: filter-adapter
  labels:
    app.kubernetes.io/part-of: triggermesh
subjects:
  - kind: ServiceAccount
    name: triggermesh-controller
    namespace: triggermesh
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: filter-adapter
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: splitter-adapter
  labels:
    app.kubernetes.io/part-of: triggermesh
subjects:
  - kind: ServiceAccount
    name: triggermesh-controller
    namespace: triggermesh
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: splitter-adapter
---
# Resolve sink URIs when Knative is installed
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: triggermesh-controller-addressable-resolver-from-knative
  labels:
    app.kubernetes.io/part-of: triggermesh
subjects:
  - kind: ServiceAccount
    name: triggermesh-controller
    namespace: triggermesh
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: addressable-resolver
---
# Resolve sink URIs when TriggerMesh Core is installed
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: triggermesh-controller-addressable-resolver-from-triggermesh
  labels:
    app.kubernetes.io/part-of: triggermesh
subjects:
  - kind: ServiceAccount
    name: triggermesh-controller
    namespace: triggermesh
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: addressable-resolver-triggermesh
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: triggermesh-controller
  namespace: triggermesh
  labels:
    app.kubernetes.io/part-of: triggermesh
spec:
  replicas: 1
  selector:
    matchLabels:
      app: triggermesh-controller
  template:
    metadata:
      labels:
        app: triggermesh-controller
    spec:
      serviceAccountName: triggermesh-controller
      containers:
        - name: controller
          terminationMessagePolicy: FallbackToLogsOnError
          image: gcr.io/triggermesh/triggermesh-controller:v1.27.0
          resources:
            requests:
              cpu: 50m
              memory: 150Mi
            limits:
              cpu: 200m
              memory: 500Mi
          env:
            - name: SYSTEM_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            # Logging/observability configuration
            - name: CONFIG_LOGGING_NAME
              value: config-logging
            - name: CONFIG_OBSERVABILITY_NAME
              value: config-observability
            - name: METRICS_DOMAIN
              value: triggermesh.io
            # Source adapters
            - name: AWSCLOUDWATCHSOURCE_IMAGE
              value: gcr.io/triggermesh/awscloudwatchsource-adapter:v1.27.0
            - name: AWSCLOUDWATCHLOGSSOURCE_IMAGE
              value: gcr.io/triggermesh/awscloudwatchlogssource-adapter:v1.27.0
            - name: AWSCODECOMMITSOURCE_IMAGE
              value: gcr.io/triggermesh/awscodecommitsource-adapter:v1.27.0
            - name: AWSCOGNITOIDENTITYSOURCE_IMAGE
              value: gcr.io/triggermesh/awscognitoidentitysource-adapter:v1.27.0
            - name: AWSCOGNITOUSERPOOLSOURCE_IMAGE
              value: gcr.io/triggermesh/awscognitouserpoolsource-adapter:v1.27.0
            - name: AWSDYNAMODBSOURCE_IMAGE
              value: gcr.io/triggermesh/awsdynamodbsource-adapter:v1.27.0
            - name: AWSKINESISSOURCE_IMAGE
              value: gcr.io/triggermesh/awskinesissource-adapter:v1.27.0
            - name: AWSPERFORMANCEINSIGHTSSOURCE_IMAGE
              value: gcr.io/triggermesh/awsperformanceinsightssource-adapter:v1.27.0
            - name: AWSSNSSOURCE_IMAGE
              value: gcr.io/triggermesh/awssnssource-adapter:v1.27.0
            - name: AWSSQSSOURCE_IMAGE
              value: gcr.io/triggermesh/awssqssource-adapter:v1.27.0
            - name: AZUREEVENTHUBSSOURCE_IMAGE
              value: gcr.io/triggermesh/azureeventhubssource-adapter:v1.27.0
            - name: AZUREIOTHUBSOURCE_IMAGE
              value: gcr.io/triggermesh/azureiothubsource-adapter:v1.27.0
            - name: AZUREQUEUESTORAGESOURCE_IMAGE
              value: gcr.io/triggermesh/azurequeuestoragesource-adapter:v1.27.0
            - name: AZURESERVICEBUSSOURCE_IMAGE
              value: gcr.io/triggermesh/azureservicebussource-adapter:v1.27.0
            - name: CLOUDEVENTSSOURCE_IMAGE
              value: gcr.io/triggermesh/cloudeventssource-adapter:v1.27.0
            - name: GOOGLECLOUDPUBSUBSOURCE_IMAGE
              value: gcr.io/triggermesh/googlecloudpubsubsource-adapter:v1.27.0
            - name: HTTPPOLLERSOURCE_IMAGE
              value: gcr.io/triggermesh/httppollersource-adapter:v1.27.0
            - name: OCIMETRICSSOURCE_IMAGE
              value: gcr.io/triggermesh/ocimetricssource-adapter:v1.27.0
            - name: KAFKASOURCE_IMAGE
              value: gcr.io/triggermesh/kafkasource-adapter:v1.27.0
            - name: MONGODBSOURCE_IMAGE
              value: gcr.io/triggermesh/mongodbsource-adapter:v1.27.0
            - name: SALESFORCESOURCE_IMAGE
              value: gcr.io/triggermesh/salesforcesource-adapter:v1.27.0
            - name: SLACKSOURCE_IMAGE
              value: gcr.io/triggermesh/slacksource-adapter:v1.27.0
            - name: SOLACESOURCE_IMAGE
              value: gcr.io/triggermesh/solacesource-adapter:v1.27.0
            - name: TWILIOSOURCE_IMAGE
              value: gcr.io/triggermesh/twiliosource-adapter:v1.27.0
            - name: WEBHOOKSOURCE_IMAGE
              value: gcr.io/triggermesh/webhooksource-adapter:v1.27.0
            - name: ZENDESKSOURCE_IMAGE
              value: gcr.io/triggermesh/zendesksource-adapter:v1.27.0
            # Target adapters
            - name: AWSCOMPREHENDTARGET_IMAGE
              value: gcr.io/triggermesh/awscomprehendtarget-adapter:v1.27.0
            - name: AWSDYNAMODBTARGET_IMAGE
              value: gcr.io/triggermesh/awsdynamodbtarget-adapter:v1.27.0
            - name: AWSEVENTBRIDGETARGET_IMAGE
              value: gcr.io/triggermesh/awseventbridgetarget-adapter:v1.27.0
            - name: AWSKINESISTARGET_IMAGE
              value: gcr.io/triggermesh/awskinesistarget-adapter:v1.27.0
            - name: AWSLAMBDATARGET_IMAGE
              value: gcr.io/triggermesh/awslambdatarget-adapter:v1.27.0
            - name: AWSS3TARGET_IMAGE
              value: gcr.io/triggermesh/awss3target-adapter:v1.27.0
            - name: AWSSNSTARGET_IMAGE
              value: gcr.io/triggermesh/awssnstarget-adapter:v1.27.0
            - name: AWSSQSTARGET_IMAGE
              value: gcr.io/triggermesh/awssqstarget-adapter:v1.27.0
            - name: AZUREEVENTHUBSTARGET_IMAGE
              value: gcr.io/triggermesh/azureeventhubstarget-adapter:v1.27.0
            - name: AZURESENTINELTARGET_IMAGE
              value: gcr.io/triggermesh/azuresentineltarget-adapter:v1.27.0
            - name: AZURESERVICEBUSTARGET_IMAGE
              value: gcr.io/triggermesh/azureservicebustarget-adapter:v1.27.0
            - name: CLOUDEVENTSTARGET_IMAGE
              value: gcr.io/triggermesh/cloudeventstarget-adapter:v1.27.0
            - name: DATADOGTARGET_IMAGE
              value: gcr.io/triggermesh/datadogtarget-adapter:v1.27.0
            - name: ELASTICSEARCHTARGET_IMAGE
              value: gcr.io/triggermesh/elasticsearchtarget-adapter:v1.27.0
            - name: GOOGLECLOUDFIRESTORETARGET_IMAGE
              value: gcr.io/triggermesh/googlecloudfirestoretarget-adapter:v1.27.0
            - name: GOOGLECLOUDSTORAGETARGET_IMAGE
              value: gcr.io/triggermesh/googlecloudstoragetarget-adapter:v1.27.0
            - name: GOOGLECLOUDWORKFLOWSTARGET_IMAGE
              value: gcr.io/triggermesh/googlecloudworkflowstarget-adapter:v1.27.0
            - name: GOOGLECLOUDPUBSUBTARGET_IMAGE
              value: gcr.io/triggermesh/googlecloudpubsubtarget-adapter:v1.27.0
            - name: GOOGLESHEETTARGET_IMAGE
              value: gcr.io/triggermesh/googlesheettarget-adapter:v1.27.0
            - name: HTTPTARGET_IMAGE
              value: gcr.io/triggermesh/httptarget-adapter:v1.27.0
            - name: JIRATARGET_IMAGE
              value: gcr.io/triggermesh/jiratarget-adapter:v1.27.0
            - name: KAFKATARGET_IMAGE
              value: gcr.io/triggermesh/kafkatarget-adapter:v1.27.0
            - name: LOGZTARGET_IMAGE
              value: gcr.io/triggermesh/logztarget-adapter:v1.27.0
            - name: MONGODBTARGET_IMAGE
              value: gcr.io/triggermesh/mongodbtarget-adapter:v1.27.0
            - name: OPENTELEMETRYTARGET_IMAGE
              value: gcr.io/triggermesh/opentelemetrytarget-adapter:v1.27.0
            - name: ORACLETARGET_IMAGE
              value: gcr.io/triggermesh/oracletarget-adapter:v1.27.0
            - name: SALESFORCETARGET_IMAGE
              value: gcr.io/triggermesh/salesforcetarget-adapter:v1.27.0
            - name: SENDGRIDTARGET_IMAGE
              value: gcr.io/triggermesh/sendgridtarget-adapter:v1.27.0
            - name: SLACKTARGET_IMAGE
              value: gcr.io/triggermesh/slacktarget-adapter:v1.27.0
            - name: SOLACETARGET_IMAGE
              value: gcr.io/triggermesh/solacetarget-adapter:v1.27.0
            - name: SPLUNKTARGET_IMAGE
              value: gcr.io/triggermesh/splunktarget-adapter:v1.27.0
            - name: TWILIOTARGET_IMAGE
              value: gcr.io/triggermesh/twiliotarget-adapter:v1.27.0
            - name: ZENDESKTARGET_IMAGE
              value: gcr.io/triggermesh/zendesktarget-adapter:v1.27.0
            # Flow adapters
            - name: JQTRANSFORMATION_IMAGE
              value: gcr.io/triggermesh/jqtransformation-adapter:v1.27.0
            - name: SYNCHRONIZER_IMAGE
              value: gcr.io/triggermesh/synchronizer-adapter:v1.27.0
            - name: TRANSFORMATION_IMAGE
              value: gcr.io/triggermesh/transformation-adapter:v1.27.0
            - name: XMLTOJSONTRANSFORMATION_IMAGE
              value: gcr.io/triggermesh/xmltojsontransformation-adapter:v1.27.0
            # Routing adapters
            - name: FILTER_IMAGE
              value: gcr.io/triggermesh/filter-adapter:v1.27.0
            - name: SPLITTER_IMAGE
              value: gcr.io/triggermesh/splitter-adapter:v1.27.0
            # Function Runtimes
            - name: RUNTIME_KLR_PYTHON
              value: gcr.io/triggermesh/knative-lambda-python310:v1.26.0
            - name: RUNTIME_KLR_NODE
              value: gcr.io/triggermesh/knative-lambda-node18:v1.26.0
            - name: RUNTIME_KLR_RUBY
              value: gcr.io/triggermesh/knative-lambda-ruby32:v1.26.0
            # Custom build adapters
            - name: IBMMQSOURCE_IMAGE
              value: gcr.io/triggermesh/ibmmqsource-adapter:v1.27.0
            - name: IBMMQTARGET_IMAGE
              value: gcr.io/triggermesh/ibmmqtarget-adapter:v1.27.0
            - name: XSLTTRANSFORMATION_IMAGE
              value: gcr.io/triggermesh/xslttransformation-adapter:v1.27.0
          securityContext:
            runAsNonRoot: true
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: [all]
          ports:
            - name: metrics
              containerPort: 9090
            - name: profiling
              containerPort: 8008
---
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  name: defaulting.webhook.triggermesh.io
  labels:
    app.kubernetes.io/part-of: triggermesh
webhooks:
  - admissionReviewVersions:
      - v1beta1
    clientConfig:
      service:
        name: triggermesh-webhook
        namespace: triggermesh
    sideEffects: None
    failurePolicy: Fail
    name: defaulting.webhook.triggermesh.io
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: validation.webhook.triggermesh.io
  labels:
    app.kubernetes.io/part-of: triggermesh
webhooks:
  - admissionReviewVersions:
      - v1beta1
    clientConfig:
      service:
        name: triggermesh-webhook
        namespace: triggermesh
    sideEffects: None
    failurePolicy: Fail
    name: validation.webhook.triggermesh.io
---
apiVersion: v1
kind: Secret
metadata:
  name: triggermesh-webhook-certs
  namespace: triggermesh
  labels:
    app.kubernetes.io/part-of: triggermesh
# The data is populated at install time.
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: triggermesh-webhook
  namespace: triggermesh
  labels:
    app.kubernetes.io/part-of: triggermesh
spec:
  replicas: 1
  selector:
    matchLabels:
      app: triggermesh-webhook
  template:
    metadata:
      annotations:
        sidecar.istio.io/inject: 'false'
      labels:
        app: triggermesh-webhook
    spec:
      serviceAccountName: triggermesh-webhook
      containers:
        - name: webhook
          terminationMessagePolicy: FallbackToLogsOnError
          image: gcr.io/triggermesh/triggermesh-webhook:v1.27.0
          env:
            - name: SYSTEM_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: CONFIG_LOGGING_NAME
              value: config-logging
            - name: METRICS_DOMAIN
              value: triggermesh.io/sources
            - name: WEBHOOK_NAME
              value: triggermesh-webhook
          ports:
            - containerPort: 9090
              name: metrics
          # TODO set proper resource limits.
          readinessProbe:
            periodSeconds: 1
            httpGet:
              scheme: HTTPS
              port: 8443
              httpHeaders:
                - name: k-kubelet-probe
                  value: webhook
          livenessProbe:
            periodSeconds: 1
            httpGet:
              scheme: HTTPS
              port: 8443
              httpHeaders:
                - name: k-kubelet-probe
                  value: webhook
---
apiVersion: v1
kind: Service
metadata:
  name: triggermesh-webhook
  namespace: triggermesh
  labels:
    app.kubernetes.io/part-of: triggermesh
spec:
  ports:
    - name: https-webhook
      port: 443
      targetPort: 8443
  selector:
    app: triggermesh-webhook
